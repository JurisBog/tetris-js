var gameManager=function(){var e=[{color:"#f00",cubes:[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:0,y:1}]},{color:"#0f0",cubes:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:-1,y:0}]},{color:"#00f",cubes:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}]},{color:"#ff0",cubes:[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:-1,y:1}]},{color:"#fff",cubes:[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:1,y:1}]},{color:"#0ff",cubes:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:-1,y:0}]},{color:"#f0f",cubes:[{x:0,y:0},{x:0,y:1},{x:-1,y:1},{x:1,y:0}]}],d=null,n={emptyCubeColor:"#000", put:function(a){var b=d.cubeDimantion;typeof a==="undefined"?(a=this.emptyCubeColor,d.paper.ctx.clearRect(this.x,this.y,b,b),this.empty=!0):(this.empty=!1,d.paper.fillRect(this.x,this.y,b,b,a));this.color=a}},f={width:600,height:700,cubeDimantion:30,arenaSize:14,previewArenaSize:5,previewArenaHeight:5,drawBase:function(){var a=this.paper,b=f.cubeDimantion*f.arenaSize;a.strokeRect(5,5,b,this.height-10);a.strokeRect(b+10,5,this.width-b-15,this.height-10);a.ctx.textAlign="left";a.fillText("NextPiece", b+25,30);a.ctx.textAlign="end"},render:function(){var a=this.arena,b=[],c=0;a.forEach(function(a,i){a.every(function(a){return!a.empty})?c+=i+1:b.push(a)});b.forEach(function(b,c){a[c].forEach(function(a,c){var h=b[c];h.empty?a.put():a.put(h.color)})});a.slice(b.length).forEach(function(a){a.forEach(function(a){a.put()})});this.score+=c;this.refreshScore()},refreshScore:function(){this.putScore(this.score)},turn:function(){var a=!0;this.movePiece(0,-1)||(this.current_piece.cubes.some(function(a){return a.y>= 23})?(clearTimeout(this.timeInterval),alert("game over")):this.enterPiece(),a=!1);return a},chooseNewNextPiece:function(){var a=Math.floor(Math.random()*e.length),b=this.next_piece,c=this.previewArena;b!=null&&b.cubes.forEach(function(a){c[a.y+2][a.x+2].put()});this.next_piece=e[a];var d=this.next_piece.color;this.next_piece.cubes.forEach(function(a){c[a.y+2][a.x+2].put(d)});return b},enterPiece:function(){var a=this.chooseNewNextPiece(),a={element:a,cubes:a.cubes.map(function(a){return{x:a.x+7,y:a.y+ 23}})};d.current_piece=a;this.render()},placePiece:function(a){var b=this.current_piece,c=b.cubes,l=d.arena,e=d.arenaSize,f;if(a.every(function(a){return a.y>=0&&a.x>=0&&a.x<e&&(a.y>=23||l[a.y][a.x].empty||c.some(function(b){return a.x===b.x&&a.y===b.y}))})){f=c.filter(function(b){return a.every(function(a){return!(a.x===b.x&&a.y===b.y)})});var g=a.filter(function(a){return c.every(function(b){return!(b.x===a.x&&b.y===a.y)})});f.forEach(function(a){a.y<23&&l[a.y][a.x].put()});g.forEach(function(a){a.y< 23&&l[a.y][a.x].put(b.element.color)});b.cubes=a;f=!0}else f=!1;return f},movePiece:function(a,b){return this.placePiece(this.current_piece.cubes.map(function(c){return{x:c.x+a,y:c.y+b}}))},start:function(){this.chooseNewNextPiece();this.enterPiece();gameManager.loop()},moveLeft:function(){this.movePiece(-1,0)},moveRight:function(){this.movePiece(1,0)},rotate:function(){var a=this.current_piece.cubes,b=a[0].x,c=a[0].y;this.placePiece(a.map(function(a){return{x:a.y-c+b,y:-(a.x-b)+c}}))},moveDown:function(){this.turn()}, moveAllDown:function(){for(;this.turn(););}};return{loop:function(){d.timeInterval=setTimeout("gameManager.loop()",d.interval-d.score);d.turn()},initialize:function(a){var b={ctx:a.getContext("2d"),strokeRect:function(a,b,c,e){var d=this.ctx;d.strokeStyle="#fff";d.lineWidth=1;d.strokeRect(a,b,c,e)},fillText:function(a,b,c){var d=this.ctx;d.fillStyle="#fff";d.fillText(a,b,c)},fillRect:function(a,b,c,d,e){var f=this.ctx;f.fillStyle=e;f.fillRect(a,b,c,d)}};b.ctx.font="20pt Arial";b.ctx.textAlign="end"; d=a={paper:b,pieces:[],current_piece:null,next_piece:null,score:0,interval:500,putScore:function(a){b.fillText(a,f.width-25,350)}};for(var c=f.cubeDimantion,e=f.arenaSize,i=[],m=f.height-5-c,g=0;g<23;g++){for(var h=[],j=0;j<e;j++){var k={empty:!0,color:null,x:j*c+5,y:m-g*c};k.__proto__=n;h.push(k)}i.push(h)}a.arena=i;for(var i=[],e=c*e+15,m=f.previewArenaSize,o=f.previewArenaHeight,p=5+c*o,g=0;g<o;g++){h=[];for(j=0;j<m;j++)k={empty:!0,color:null,x:j*c+5+e,y:p-g*c},k.__proto__=n,h.push(k);i.push(h)}a.previewArena= i;a.putScore(a.score);a.__proto__=f;a.drawBase();return a}}}();window.onload=function(){var e=gameManager.initialize(document.getElementById("c"));document.addEventListener("keydown",function(d){switch(d.keyCode){case 13:e.moveAllDown();break;case 37:e.moveLeft();break;case 38:e.rotate();break;case 39:e.moveRight();break;case 40:e.moveDown()}},!1);e.start()};