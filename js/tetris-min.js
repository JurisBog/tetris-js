var gameManager=function(){var d=[{color:"#f00",cubes:[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:0,y:1}]},{color:"#0f0",cubes:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:-1,y:0}]},{color:"#00f",cubes:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}]},{color:"#ff0",cubes:[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:-1,y:1}]},{color:"#fff",cubes:[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:1,y:1}]},{color:"#0ff",cubes:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:-1,y:0}]},{color:"#f0f",cubes:[{x:0,y:0},{x:0,y:1},{x:-1,y:1},{x:1,y:0}]}],g=null,m={emptyCubeColor:"#000", put:function(a){typeof a==="undefined"?(a=this.emptyCubeColor,this.empty=!0):this.empty=!1;this.color=a;this.cube.attr("fill",a)}},e={width:600,height:700,cubeDimantion:30,arenaSize:14,previewArenaSize:5,previewArenaHeight:5,drawBase:function(){var a=this.paper,b=e.cubeDimantion*e.arenaSize;a.rect(5,5,b,this.height-10).attr("stroke","#fff");a.rect(b+10,5,this.width-b-15,this.height-10).attr("stroke","#fff");a.text(b+50,20,"Next Piece").attr({fill:"#fff","font-size":15,"text-anchor":"start"})},render:function(){var a= this.arena,b=[],c=0;a.forEach(function(a,j){a.every(function(a){return!a.empty})?c+=j+1:b.push(a)});b.forEach(function(b,c){a[c].forEach(function(a,c){var h=b[c];h.empty?a.put():a.put(h.color)})});a.slice(b.length).forEach(function(a){a.forEach(function(a){a.put()})});this.score+=c;this.refreshScore()},refreshScore:function(){this.scoreText.attr("text",this.score)},turn:function(){var a=!0;this.movePiece(0,-1)||(this.current_piece.cubes.some(function(a){return a.y>=23})?(clearTimeout(this.timeInterval), alert("game over")):this.enterPiece(),a=!1);return a},chooseNewNextPiece:function(){var a=Math.floor(Math.random()*d.length),b=this.next_piece,c=this.previewArena;b!=null&&b.cubes.forEach(function(a){c[a.y+2][a.x+2].put()});this.next_piece=d[a];var i=this.next_piece.color;this.next_piece.cubes.forEach(function(a){c[a.y+2][a.x+2].put(i)});return b},enterPiece:function(){var a=this.chooseNewNextPiece(),a={element:a,cubes:a.cubes.map(function(a){return{x:a.x+7,y:a.y+23}})};g.current_piece=a;this.render()}, placePiece:function(a){var b=this.current_piece,c=b.cubes,i=g.arena,e=g.arenaSize,f;if(a.every(function(a){return a.y>=0&&a.x>=0&&a.x<e&&(a.y>=23||i[a.y][a.x].empty||c.some(function(b){return a.x===b.x&&a.y===b.y}))})){f=c.filter(function(b){return a.every(function(a){return!(a.x===b.x&&a.y===b.y)})});var d=a.filter(function(a){return c.every(function(b){return!(b.x===a.x&&b.y===a.y)})});f.forEach(function(a){a.y<23&&i[a.y][a.x].put()});d.forEach(function(a){a.y<23&&i[a.y][a.x].put(b.element.color)}); b.cubes=a;f=!0}else f=!1;return f},movePiece:function(a,b){return this.placePiece(this.current_piece.cubes.map(function(c){return{x:c.x+a,y:c.y+b}}))},start:function(){this.chooseNewNextPiece();this.enterPiece();gameManager.loop()},moveLeft:function(){this.movePiece(-1,0)},moveRight:function(){this.movePiece(1,0)},rotate:function(){var a=this.current_piece.cubes,b=a[0].x,c=a[0].y;this.placePiece(a.map(function(a){return{x:a.y-c+b,y:-(a.x-b)+c}}))},moveDown:function(){this.turn()},moveAllDown:function(){for(;this.turn();); }};return{loop:function(){g.timeInterval=setTimeout("gameManager.loop()",g.interval-g.score);g.turn()},initialize:function(a){g=a={paper:new Raphael(a,e.width,e.height),pieces:[],current_piece:null,next_piece:null,score:0,interval:500};for(var b=e.cubeDimantion,c=e.arenaSize,d=[],j=e.height-5-b,f=0;f<23;f++){for(var k=[],h=0;h<c;h++){var l={empty:!0,color:null,cube:a.paper.rect(h*b+5,j-f*b,b,b)};l.__proto__=m;k.push(l)}d.push(k)}a.arena=d;for(var d=[],c=b*c+15,j=e.previewArenaSize,n=e.previewArenaHeight, o=5+b*n,f=0;f<n;f++){k=[];for(h=0;h<j;h++)l={empty:!0,color:null,cube:a.paper.rect(h*b+5+c,o-f*b,b,b)},l.__proto__=m,k.push(l);d.push(k)}a.previewArena=d;b=a.paper.text(e.width-25,350,a.score);b.attr({fill:"#fff","font-size":35,"text-anchor":"end"});a.scoreText=b;a.__proto__=e;a.drawBase();return a}}}(); window.onload=function(){var d=gameManager.initialize(document.getElementById("canvas_container"));document.addEventListener("keydown",function(g){switch(g.keyCode){case 13:d.moveAllDown();break;case 37:d.moveLeft();break;case 38:d.rotate();break;case 39:d.moveRight();break;case 40:d.moveDown()}},!1);d.start()};